# Архитектура бота

Чат-бот построен по следующей архитектуре:

1. **Обработчики команд**: Используются для обработки команд, таких как /start, и для обработки входящих текстовых сообщений.
2. **База данных**: SQLite используется для хранения информации о пользователях и их сообщениях. Создаются две таблицы: `users` для хранения информации о пользователях и `messages` для хранения сообщений.
3. **Обработка сообщений**: Каждое входящее сообщение обрабатывается для определения намерения пользователя с помощью NLP и заранее заданных ключевых слов. В зависимости от намерения формируется ответ.
4. **Кластеризация вопросов**: Используется KMeans для анализа сообщений и определения наиболее часто задаваемых вопросов.
5. **Интеграция с OpenAI**: Бот использует API OpenAI для генерации ответов на запросы, которые не могут быть обработаны на основе заранее заданных намерений.

## Используемые технологии

1. **Python**: Основной язык программирования для разработки бота.
2. **python-telegram-bot**: Библиотека для взаимодействия с Telegram API, которая упрощает создание ботов.
3. **SQLite**: Легковесная реляционная база данных, использованная для хранения данных пользователей и сообщений.
4. **spaCy**: Библиотека для обработки естественного языка, использованная для анализа сообщений и определения намерений пользователей.
5. **scikit-learn**: Библиотека для машинного обучения, использованная для кластеризации сообщений с помощью алгоритма KMeans.
6. **LangChain**: Библиотека для работы с языковыми моделями, которая интегрирует OpenAI API для генерации ответов на запросы пользователей.

## Проблемы и их решения

1. **Определение намерений**: Изначально бот иногда неправильно интерпретировал намерения пользователей. Это было исправлено путем добавления дополнительных ключевых слов и улучшения логики обработки сообщений. Сильно зависит от того, как ставится вопрос.
2. **Кластеризация сообщений**: Возникли трудности с выбором оптимального числа кластеров при использовании K-means. Проблема была решена путем экспериментов с различными значениями k и выбора наилучшего на основе анализа полученных результатов.
3. **Обработка ошибок**: Бот иногда выдавал некорректные ответы на нераспознанные запросы. Для улучшения ситуации была внедрена логика обработки ошибок, позволяющая возвращать пользователям более информативные сообщения.
4. **Удаление тестовых данных**: Перед финальной проверкой была проведена очистка базы данных от тестовых сессий общения с ботом.
5. **Проблемы контекста**: Проблема с реализацией контекста была решена путем интеграции библиотеки Longchain.
6. **Проблема с блокировкой российских пользователей**: Не так просто получить API KEY к OpenAI. Пришлось воспользоваться сторонним ресурсом PROXYAPI и переназначить пути.

## Доступные функции для пользователей

1. **Список пользователей**: Бот может предоставить список всех пользователей, взаимодействующих с ним.
2. **Последние сообщения**: Пользователи могут запрашивать последние сообщения, и бот вернет их в виде списка.
3. **Популярные вопросы**: Бот может предоставить информацию о самых частых вопросах, заданных пользователями.
4. **Поиск цензуры**: Админская функция для поиска пользователей, написавших непотребство, с дальнейшей блокировкой или выговором. Работает при вводе команды `censorship_bot`. Для работы функции нужно ввести в файл `censorship.txt` слова-триггеры, которые она будет искать.
5. **Сообщения других пользователей**: Бот сообщает о запросах других пользователей.

## Дополнительная информация

- Бот использует SQLite для хранения данных, что обеспечивает простоту и удобство управления.
- Для обработки естественного языка применяется библиотека spaCy, что позволяет более точно анализировать текстовые сообщения.
- Интеграция с OpenAI позволяет боту генерировать ответы на открытые вопросы, делая его более интерактивным.
- Все данные о пользователях и их сообщениях доступны для анализа, что соответствует требованиям задания.

Реализован весь функционал, какой требовало задание. Работает не на 100%, но выполняет практически всегда запросы пользователя (разница в том, как задать вопрос).
